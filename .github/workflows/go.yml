name: Go Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: 
          - notification-service
          - email-worker
          - sms-worker
          - slack-worker
        go-version: [ "1.24.x" ]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      
      - name: Install gotestfmt
        run: go install github.com/gotesttools/gotestfmt/v2/cmd/gotestfmt@latest
      
      - name: Build and Test ${{ matrix.module }}
        working-directory: ./${{ matrix.module }}
        run: |
          echo "Running go mod tidy in ${{ matrix.module }}"
          go mod tidy
          echo "Building ${{ matrix.module }}..."
          go build -v ./...
          echo "Running tests for ${{ matrix.module }}..."
          # Use gotestfmt for nicely formatted test output
          go test -cover -json -v ./... 2>&1 | gotestfmt
